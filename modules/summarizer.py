# modules/summarizer.py
import logging
from openai import OpenAI
import config

# Создаем клиент OpenAI с API-ключом (по умолчанию берет OPENAI_API_KEY из окружения)
openai_client = OpenAI(api_key=config.OPENAI_API_KEY)


def generate_summary(news_text: str, custom_prompt: str = None) -> str:
    """
    Генерирует краткое содержание для заданного текста новостей с использованием OpenAI API.

    :param news_text: Текст новостей для суммаризации.
    :param custom_prompt: (Опционально) Дополнительный промпт, задающий стиль и формат саммари.
    :return: Сгенерированное саммари или сообщение об ошибке.
    """
    # Если пользовательский промпт не передан, используем стандартный
    if custom_prompt is None:
        custom_prompt = "Сделай краткое, но ёмкое саммари следующих новостей на русском языке:"
    prompt = f"{custom_prompt}\n\n{news_text}"

    try:
        # Вызываем Chat Completion через клиент OpenAI (новый формат вызова)
        response = openai_client.chat.completions.create(
            model="gpt-4o",
            messages=[
                {
                    "role": "system",
                    "content": "Ты – опытный программист и специалист по AI, освещающий новости об искусственном интеллекте."
                },
                {"role": "user", "content": prompt},
            ],
            max_tokens=700,
            temperature=0.5,
        )
        # Извлекаем текст ответа (content) из первого варианта
        summary = response.choices[0].message.content.strip()
        return summary
    except Exception as e:
        logging.error("Ошибка генерации саммари: %s", e)
        return "Ошибка генерации саммари."


if __name__ == "__main__":
    # Пример использования
    sample_text = (
        "Новость 1: Компания X запустила новую платформу для разработки AI. "
        "Новость 2: Исследователи продемонстрировали прорыв в обработке естественного языка."
    )
    custom_prompt = (
        "Ты – опытный программист и специалист по AI, освещающий новости об искусственном интеллекте для Telegram-канала. "
        "Ты смотришь на технологии с лёгким юмором и уверен, что AI – это всего лишь инструмент, без сценариев восстания машин, потому что у него нет собственных желаний. "
        "AI – мощный, но, как и любой инструмент, его эффективность зависит от того, кто и как его использует. "
        "Твоя задача – делать краткое, но ёмкое саммари статьи на русском языке без потери сути, сохраняя баланс между информативностью и лёгкой ироничностью. "
        "Заголовок должен быть жирным текстом, но без специальных символов, просто текст заголовка с начальной заглавной буквы, основанный на \"Титул\", но с живостью и интригой. "
        "Текст 250–300 слов, с чёткой структурой, без лишней воды. "
        "Обязательно укажи автора и источник URL-адрес. "
        "Если статья подаёт AI в слишком драматичном или паническом тоне, ты мягко иронизируешь над этим, объясняя, что он не более опасен, чем молоток в умелых руках. "
        "Если речь о достижениях AI, подчёркивай, что технологии – это возможности, но за ними всегда стоит человеческий труд. "
        "Пиши живо, с изюминкой, чтобы читателю хотелось делиться твоим текстом!"
    )
    result = generate_summary(sample_text, custom_prompt)
    print(result)

