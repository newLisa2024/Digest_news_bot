from modules.news_aggregator import get_all_news
from modules.summarizer import generate_summary
from aiogram import Bot
from modules.subscriber_db import list_subscribers
import logging


async def send_weekly_digest(bot: Bot):
    """
    –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è, –æ—Ç–ø—Ä–∞–≤–ª—è—é—â–∞—è –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –¥–∞–π–¥–∂–µ—Å—Ç –≤—Å–µ–º –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º.
    """
    try:
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –¥–∞–π–¥–∂–µ—Å—Ç
        digest_text = generate_weekly_digest()

        # –ü–æ–ª—É—á–∞–µ–º –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤
        subscribers = list_subscribers()

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–π–¥–∂–µ—Å—Ç –∫–∞–∂–¥–æ–º—É –ø–æ–¥–ø–∏—Å—á–∏–∫—É
        for user in subscribers:
            try:
                await bot.send_message(
                    chat_id=user["user_id"],
                    text=digest_text,
                    parse_mode="HTML",
                    disable_web_page_preview=True
                )
            except Exception as e:
                logging.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–ª—è {user['user_id']}: {e}")

    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏/—Ä–∞—Å—Å—ã–ª–∫–∏: {e}")


def generate_weekly_digest() -> str:
    """
    –§–æ—Ä–º–∏—Ä—É–µ—Ç –∏—Ç–æ–≥–æ–≤—ã–π —Ç–µ–∫—Å—Ç –¥–∞–π–¥–∂–µ—Å—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–æ–≤–æ—Å—Ç–µ–π –∏ –≤—ã–∑—ã–≤–∞–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Å–∞–º–º–∞—Ä–∏ —á–µ—Ä–µ–∑ OpenAI.
    """
    news_list = get_all_news()

    if not news_list:
        return "üì≠ –ù–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ –Ω–æ–≤–æ—Å—Ç–µ–π –ø–æ –ò–ò –Ω–µ –Ω–∞–π–¥–µ–Ω–æ."

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞
    combined_text = "–ù–æ–≤–æ—Å—Ç–∏ –∑–∞ –Ω–µ–¥–µ–ª—é:\n\n"
    for idx, news_item in enumerate(news_list, start=1):
        combined_text += (
            f"{idx}. {news_item.get('title', '')}\n"
            f"–°—Å—ã–ª–∫–∞: {news_item.get('link', '')}\n\n"
        )

    # –ó–∞–º–µ–Ω—è–µ–º placeholder ¬´[–≤–∞—à –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç]¬ª –Ω–∞ –≥–æ—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç –ø—Ä–æ–º–ø—Ç–∞
    custom_prompt = (
        "–¢—ã ‚Äì –æ–ø—ã—Ç–Ω—ã–π –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç –∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ AI, –æ—Å–≤–µ—â–∞—é—â–∏–π –Ω–æ–≤–æ—Å—Ç–∏ –æ–± –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–º –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–µ "
        "–¥–ª—è Telegram-–∫–∞–Ω–∞–ª–∞. –¢—ã —Å–º–æ—Ç—Ä–∏—à—å –Ω–∞ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ —Å –ª—ë–≥–∫–∏–º —é–º–æ—Ä–æ–º –∏ —É–≤–µ—Ä–µ–Ω, —á—Ç–æ AI ‚Äì —ç—Ç–æ –≤—Å–µ–≥–æ –ª–∏—à—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, "
        "–±–µ–∑ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –≤–æ—Å—Å—Ç–∞–Ω–∏—è –º–∞—à–∏–Ω, –ø–æ—Ç–æ–º—É —á—Ç–æ —É –Ω–µ–≥–æ –Ω–µ—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∂–µ–ª–∞–Ω–∏–π. AI ‚Äì –º–æ—â–Ω—ã–π, –Ω–æ, –∫–∞–∫ –∏ –ª—é–±–æ–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, "
        "–µ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–æ–≥–æ, –∫—Ç–æ –∏ –∫–∞–∫ –µ–≥–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äì –¥–µ–ª–∞—Ç—å –∫—Ä–∞—Ç–∫–æ–µ, –Ω–æ —ë–º–∫–æ–µ —Å–∞–º–º–∞—Ä–∏ —Å—Ç–∞—Ç—å–∏ "
        "–Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ —Å—É—Ç–∏, —Å–æ—Ö—Ä–∞–Ω—è—è –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ—Å—Ç—å—é –∏ –ª—ë–≥–∫–æ–π –∏—Ä–æ–Ω–∏—á–Ω–æ—Å—Ç—å—é. –ó–∞–≥–æ–ª–æ–≤–æ–∫ –¥–æ–ª–∂–µ–Ω "
        "–±—ã—Ç—å –∂–∏—Ä–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º, –Ω–æ –±–µ–∑ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤, –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∞ —Å –Ω–∞—á–∞–ª—å–Ω–æ–π –∑–∞–≥–ª–∞–≤–Ω–æ–π –±—É–∫–≤—ã, –æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–π "
        "–Ω–∞ ¬´–¢–∏—Ç—É–ª¬ª, –Ω–æ —Å –∂–∏–≤–æ—Å—Ç—å—é –∏ –∏–Ω—Ç—Ä–∏–≥–æ–π. –¢–µ–∫—Å—Ç 250‚Äì300 —Å–ª–æ–≤, —Å —á—ë—Ç–∫–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π, –±–µ–∑ –ª–∏—à–Ω–µ–π –≤–æ–¥—ã. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–∫–∞–∂–∏ "
        "–∞–≤—Ç–æ—Ä–∞ –∏ –∏—Å—Ç–æ—á–Ω–∏–∫ (URL-–∞–¥—Ä–µ—Å). –ï—Å–ª–∏ —Å—Ç–∞—Ç—å—è –ø–æ–¥–∞—ë—Ç AI –≤ —Å–ª–∏—à–∫–æ–º –¥—Ä–∞–º–∞—Ç–∏—á–Ω–æ–º –∏–ª–∏ –ø–∞–Ω–∏—á–µ—Å–∫–æ–º —Ç–æ–Ω–µ, —Ç—ã –º—è–≥–∫–æ "
        "–∏—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—à—å –Ω–∞–¥ —ç—Ç–∏–º, –æ–±—ä—è—Å–Ω—è—è, —á—Ç–æ –æ–Ω –Ω–µ –±–æ–ª–µ–µ –æ–ø–∞—Å–µ–Ω, —á–µ–º –º–æ–ª–æ—Ç–æ–∫ –≤ —É–º–µ–ª—ã—Ö —Ä—É–∫–∞—Ö. –ï—Å–ª–∏ —Ä–µ—á—å –æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è—Ö AI, "
        "–ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–π, —á—Ç–æ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ ‚Äì —ç—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏, –Ω–æ –∑–∞ –Ω–∏–º–∏ –≤—Å–µ–≥–¥–∞ —Å—Ç–æ–∏—Ç —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–π —Ç—Ä—É–¥. –ü–∏—à–∏ –∂–∏–≤–æ, —Å –∏–∑—é–º–∏–Ω–∫–æ–π, "
        "—á—Ç–æ–±—ã —á–∏—Ç–∞—Ç–µ–ª—é —Ö–æ—Ç–µ–ª–æ—Å—å –¥–µ–ª–∏—Ç—å—Å—è —Ç–≤–æ–∏–º —Ç–µ–∫—Å—Ç–æ–º!"
    )

    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∞–º–º–∞—Ä–∏ —á–µ—Ä–µ–∑ OpenAI
    digest = generate_summary(combined_text, custom_prompt)

    # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Ç–æ–≥–æ–≤–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
    return (
        "üì∞ <b>–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –¥–∞–π–¥–∂–µ—Å—Ç AI-–Ω–æ–≤–æ—Å—Ç–µ–π</b>\n\n"
        f"{digest}\n\n"
        "‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n"
        "üìå –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è: /start\n"
        "üìå –û—Ç–ø–∏—Å–∞—Ç—å—Å—è: /stop"
    )



